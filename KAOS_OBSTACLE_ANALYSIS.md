# KAOS障害分析（Obstacle Analysis）

**プロジェクト**: Satellite Data Viewer
**作成日**: 2026-01-25
**目的**: システムゴールの達成を阻害する障害を特定し、回避策を設計する

---

## 目次

1. [障害分析の概要](#障害分析の概要)
2. [ゴール別障害分析](#ゴール別障害分析)
3. [障害の優先度評価](#障害の優先度評価)
4. [回避策の実装状況](#回避策の実装状況)

---

## 障害分析の概要

### 障害（Obstacle）とは

**定義**: システムゴールの達成を妨げる条件や事象

**分類**:
- **環境障害**: 外部環境に起因（例: ネットワーク障害）
- **ソフトウェア障害**: 実装の不備に起因（例: バグ、性能不足）
- **人的障害**: ユーザーの誤操作に起因（例: 不正な入力）

### 分析プロセス

```
1. ゴールの否定形を作成
   ↓
2. 障害の原因を特定（AND/OR分解）
   ↓
3. 障害の影響度・発生確率を評価
   ↓
4. 回避策（Resolution）を設計
   ↓
5. ゴールの精緻化または要求の追加
```

---

## ゴール別障害分析

### G1: 観測データを可視化する

#### 障害 O1-1: 衛星データが取得できない

**障害記述**:
```
IF JAXA G-Portal APIが応答しない
THEN 衛星データが取得できない
RESULTING IN G1.1（衛星データを地図表示）が達成不可能
```

**原因分析（AND/OR分解）**:
```
O1-1: 衛星データ取得失敗
├─ [OR] O1-1-1: ネットワーク障害
│  ├─ [AND] インターネット接続断
│  └─ [AND] JAXA APIサーバーダウン
├─ [OR] O1-1-2: 認証エラー
│  ├─ [AND] APIキーの期限切れ
│  └─ [AND] APIキーの設定ミス
└─ [OR] O1-1-3: データ不在
   ├─ [AND] 指定期間にデータが存在しない
   └─ [AND] 観測地点が観測範囲外
```

**影響度**: 🔴 高（システムの中核機能が停止）

**発生確率**: 🟡 中（JAXA APIの可用性99%と仮定）

**回避策（Resolution）**:

```
R1-1-1: キャッシュ機構の導入
├─ 最後に成功したデータをローカルに保存
├─ API障害時はキャッシュから表示
└─ 実装状態: 🔶 未実装（今後の課題）

R1-1-2: フォールバック表示
├─ 「データ取得中...」のローディング表示
├─ 「データが見つかりません」のメッセージ
└─ 実装状態: ✅ 実装済み（frontend/js/app.js:184）

R1-1-3: リトライ機構
├─ 3回まで自動リトライ（指数バックオフ）
├─ タイムアウト設定（30秒）
└─ 実装状態: 🔶 未実装（今後の課題）

R1-1-4: エラーログ記録
├─ API呼び出し失敗をログに記録
├─ 管理者への通知機能
└─ 実装状態: ✅ 実装済み（backend/api.php:writeLog）
```

**新規ゴール追加**:
```
G1.4: データ取得の信頼性を確保する
├─ G1.4.1: キャッシュ機構を実装する
├─ G1.4.2: リトライ機構を実装する
└─ G1.4.3: フォールバック表示を提供する（実装済み）
```

---

#### 障害 O1-2: 座標がずれる

**障害記述**:
```
IF 衛星データと気象観測所の座標が大きくずれている
THEN 平年値との比較が不正確になる
RESULTING IN G1.2（平年値との比較分析）が達成不可能
```

**原因分析**:
```
O1-2: 座標ズレによる不正確な比較
├─ [OR] O1-2-1: 入力データの誤り
│  ├─ [AND] ユーザーが緯度・経度を誤入力
│  └─ [AND] 小数点以下の桁数不足
├─ [OR] O1-2-2: 最寄り観測所の誤検出
│  ├─ [AND] Haversine公式の計算誤差
│  └─ [AND] 観測所データベースの不備
└─ [OR] O1-2-3: 地図とDBの座標系不一致
   ├─ [AND] WGS84とJGD2011の混在
   └─ [AND] 座標変換の欠如
```

**影響度**: 🟡 中（比較結果の信頼性低下）

**発生確率**: 🟢 低（入力バリデーションで防止）

**回避策（Resolution）**:

```
R1-2-1: リアルタイムバリデーション
├─ 緯度: -90～90度、経度: -180～180度
├─ 日本国内推奨範囲の警告表示
└─ 実装状態: ✅ 実装済み（frontend/js/app.js:76-118）

R1-2-2: Haversine公式の精度向上
├─ 浮動小数点演算の精度確保
├─ 単体テスト（誤差 < 1km）
└─ 実装状態: ✅ 実装済み（backend/api.php:746-780）

R1-2-3: 座標ズレ検出機構
├─ 最寄り観測所との距離を表示
├─ 50km以上離れている場合は警告
└─ 実装状態: 🔶 未実装（今後の課題）

R1-2-4: 座標系の統一
├─ すべてWGS84（GPS準拠）に統一
├─ データベース登録時に座標系を記録
└─ 実装状態: ✅ 実装済み（データベース設計）
```

**新規要求追加**:
```
NFR1.1: Haversine公式の計算誤差は1km未満であること
NFR1.2: 最寄り観測所との距離が50km以上の場合、警告を表示すること
```

---

### G2: データの信頼性を保証する

#### 障害 O2-1: セキュリティテストの未実施

**障害記述**:
```
IF デプロイ前にセキュリティテストを実行しない
THEN 脆弱性が本番環境に混入する
RESULTING IN G2.2（セキュリティ脅威防御）が達成不可能
```

**原因分析**:
```
O2-1: セキュリティテスト未実施
├─ [OR] O2-1-1: テストスクリプトの欠如
│  └─ [AND] 自動化されていない
├─ [OR] O2-1-2: デプロイプロセスの不備
│  ├─ [AND] テストが必須ステップでない
│  └─ [AND] チェックリストの不在
└─ [OR] O2-1-3: 時間的制約
   └─ [AND] 手動テストに時間がかかる
```

**影響度**: 🔴 高（セキュリティ侵害のリスク）

**発生確率**: 🟡 中（人的プロセスに依存）

**回避策（Resolution）**:

```
R2-1-1: セキュリティテスト自動化
├─ test_security.sh の作成（12項目）
├─ SQLインジェクション、XSS、入力検証を網羅
└─ 実装状態: ✅ 実装済み（backend/test_security.sh）

R2-1-2: CI/CDパイプラインへの組み込み
├─ GitHub Actionsでプッシュ時に自動実行
├─ テスト失敗時はデプロイをブロック
└─ 実装状態: 🔶 未実装（今後の課題）

R2-1-3: デプロイチェックリストの作成
├─ セキュリティテスト実施確認
├─ ログファイルの確認
└─ 実装状態: ✅ 実装済み（DEPLOYMENT.md）

R2-1-4: 継続的セキュリティスキャン
├─ OWASP ZAPによる自動スキャン
├─ 週次でのスキャン実施
└─ 実装状態: 🔶 未実装（今後の課題）
```

**新規ゴール追加**:
```
G2.4: セキュリティテストの継続的実施を保証する
├─ G2.4.1: CI/CDパイプラインを構築する
├─ G2.4.2: 週次でセキュリティスキャンを実施する
└─ G2.4.3: テスト結果をダッシュボード化する
```

---

#### 障害 O2-2: SQLインジェクション攻撃の成功

**障害記述**:
```
IF プリペアドステートメントを使用しないSQL文が存在する
THEN SQLインジェクション攻撃が成功する
RESULTING IN G2.2.1（SQLi防御）が達成不可能
```

**原因分析**:
```
O2-2: SQLインジェクション攻撃成功
├─ [OR] O2-2-1: プリペアドステートメント未使用
│  ├─ [AND] 動的SQLの直接実行
│  └─ [AND] 文字列連結によるクエリ構築
├─ [OR] O2-2-2: 入力バリデーション不足
│  ├─ [AND] is_numeric()のチェック欠如
│  └─ [AND] エスケープ処理の欠如
└─ [OR] O2-2-3: 二重エスケープの脆弱性
   └─ [AND] エスケープ処理の重複実行
```

**影響度**: 🔴 高（データベース全体の漏洩・改ざん）

**発生確率**: 🟢 低（プリペアドステートメントで防止）

**回避策（Resolution）**:

```
R2-2-1: 全SQL文でプリペアドステートメント使用
├─ PDO::prepare() + bindParam()
├─ 動的SQLの全面禁止
└─ 実装状態: ✅ 実装済み（backend/api.php全体）

R2-2-2: 入力値の型チェック強化
├─ is_numeric() + floatval()
├─ 範囲チェック（緯度・経度）
└─ 実装状態: ✅ 実装済み（backend/api.php:445-471）

R2-2-3: セキュリティテストでの検証
├─ ' OR '1'='1 パターンのテスト
├─ UNION SELECT攻撃のテスト
└─ 実装状態: ✅ 実装済み（test_security.sh:Test 1,2）

R2-2-4: コードレビューガイドライン
├─ すべてのDB操作をレビュー対象に
├─ プリペアドステートメント使用を必須化
└─ 実装状態: 🔶 未実装（今後の課題）
```

**Alloy形式的検証との連携**:
```alloy
// セキュリティ制約（satellite_viewer_enhanced.als より）
fact AllQueriesUsePreparedStatements {
  all q: SQLQuery | q.uses_prepared_statement = True
}

assert SQLInjectionAlwaysPrevented {
  all q: SQLQuery | q.uses_prepared_statement = True
}

check SQLInjectionAlwaysPrevented for 10
// → No counterexample found（検証成功）
```

---

#### 障害 O2-3: XSS攻撃の成功

**障害記述**:
```
IF ユーザー入力がエスケープされずにHTMLに出力される
THEN XSS攻撃が成功する
RESULTING IN G2.2.2（XSS防御）が達成不可能
```

**原因分析**:
```
O2-3: XSS攻撃成功
├─ [OR] O2-3-1: HTMLエスケープ不足
│  ├─ [AND] <script>タグの直接出力
│  └─ [AND] イベントハンドラの挿入
├─ [OR] O2-3-2: 入力サニタイズ不足
│  ├─ [AND] strip_tags()の未適用
│  └─ [AND] ホワイトリスト検証の欠如
└─ [OR] O2-3-3: JSONレスポンスの脆弱性
   └─ [AND] Content-Type未指定
```

**影響度**: 🟡 中（セッション乗っ取り、情報漏洩）

**発生確率**: 🟢 低（strip_tags()で防止）

**回避策（Resolution）**:

```
R2-3-1: 入力時のHTMLタグ除去
├─ strip_tags()による無害化
├─ name, prefecture, city, station_nameに適用
└─ 実装状態: ✅ 実装済み（backend/api.php:446,477-480）

R2-3-2: JSONレスポンスの適切な設定
├─ Content-Type: application/json
├─ X-Content-Type-Options: nosniff
└─ 実装状態: ✅ 実装済み（backend/api.php:ヘッダー設定）

R2-3-3: セキュリティテストでの検証
├─ <script>alert('XSS')</script> のテスト
├─ <img src=x onerror=alert(1)> のテスト
└─ 実装状態: ✅ 実装済み（test_security.sh:Test 3）

R2-3-4: Content Security Policy (CSP)の導入
├─ script-src 'self'のみ許可
├─ inline-scriptの禁止
└─ 実装状態: 🔶 未実装（今後の課題）
```

**新規要求追加**:
```
NFR2.1: すべてのユーザー入力はstrip_tags()でサニタイズすること
NFR2.2: Content Security Policyを設定し、外部スクリプト実行を禁止すること
```

---

### G3: 使いやすいUI提供

#### 障害 O3-1: ユーザー入力の誤り

**障害記述**:
```
IF ユーザーが範囲外の緯度・経度を入力する
THEN データベースに不正なデータが挿入される
RESULTING IN G2.1（入力データ検証）が達成不可能
```

**原因分析**:
```
O3-1: 不正な入力データの挿入
├─ [OR] O3-1-1: フロントエンド検証の回避
│  ├─ [AND] JavaScriptの無効化
│  └─ [AND] 直接API呼び出し
├─ [OR] O3-1-2: バックエンド検証の欠如
│  ├─ [AND] 範囲チェック未実施
│  └─ [AND] 型チェック未実施
└─ [OR] O3-1-3: データベース制約の欠如
   └─ [AND] CHECK制約未定義
```

**影響度**: 🟡 中（データ品質の低下）

**発生確率**: 🟡 中（悪意ある操作の可能性）

**回避策（Resolution）**:

```
R3-1-1: フロントエンドリアルタイムバリデーション
├─ blur/inputイベントで即座に検証
├─ エラーメッセージを日本語で表示
└─ 実装状態: ✅ 実装済み（frontend/js/app.js:76-118）

R3-1-2: バックエンド二重検証
├─ is_numeric() + floatval()
├─ 緯度: -90～90, 経度: -180～180
└─ 実装状態: ✅ 実装済み（backend/api.php:445-471）

R3-1-3: データベースCHECK制約
├─ ALTER TABLE locations ADD CHECK (latitude >= -90 AND latitude <= 90)
├─ ALTER TABLE locations ADD CHECK (longitude >= -180 AND longitude <= 180)
└─ 実装状態: 🔶 未実装（今後の課題）

R3-1-4: APIレート制限
├─ 同一IPから1分間に10リクエストまで
├─ 超過時は429 Too Many Requestsを返す
└─ 実装状態: 🔶 未実装（今後の課題）
```

**新規ゴール追加**:
```
G3.4: 不正な入力を多層的に防御する
├─ G3.4.1: フロントエンド検証を実装する（実装済み）
├─ G3.4.2: バックエンド検証を実装する（実装済み）
├─ G3.4.3: データベースCHECK制約を定義する
└─ G3.4.4: APIレート制限を実装する
```

---

#### 障害 O3-2: パフォーマンス低下

**障害記述**:
```
IF 大量のデータを一度に取得・表示しようとする
THEN システムのレスポンスが著しく低下する
RESULTING IN G3.1（直感的操作性）が達成不可能
```

**原因分析**:
```
O3-2: パフォーマンス低下
├─ [OR] O3-2-1: データベースクエリの非効率性
│  ├─ [AND] インデックス未設定
│  └─ [AND] N+1問題
├─ [OR] O3-2-2: フロントエンドの描画遅延
│  ├─ [AND] 大量のDOMノード生成
│  └─ [AND] Chart.jsの再描画コスト
└─ [OR] O3-2-3: ネットワーク遅延
   └─ [AND] 大きなJSONレスポンス
```

**影響度**: 🟡 中（ユーザー体験の低下）

**発生確率**: 🟡 中（データ量増加に伴い発生）

**回避策（Resolution）**:

```
R3-2-1: データベースインデックス最適化
├─ location_id, observation_date にインデックス
├─ EXPLAIN ANALYZEでクエリ分析
└─ 実装状態: ✅ 実装済み（backend/db_setup.sql:インデックス定義）

R3-2-2: ページネーション導入
├─ 1ページあたり100件まで
├─ LIMIT/OFFSETによる分割取得
└─ 実装状態: 🔶 未実装（今後の課題）

R3-2-3: 遅延ロード（Lazy Loading）
├─ 地図の可視範囲内のデータのみ取得
├─ スクロール時に追加ロード
└─ 実装状態: 🔶 未実装（今後の課題）

R3-2-4: キャッシング機構
├─ ブラウザキャッシュ（Cache-Control）
├─ サーバーサイドキャッシュ（Redis）
└─ 実装状態: 🔶 未実装（今後の課題）

R3-2-5: Chart.jsの最適化
├─ アニメーション無効化（animation: false）
├─ データポイント間引き（decimation）
└─ 実装状態: 🔶 未実装（今後の課題）
```

**新規非機能要求追加**:
```
NFR3.1: 地図の初期表示は3秒以内であること
NFR3.2: グラフの描画は1秒以内であること
NFR3.3: 1ページあたりのデータ件数は100件以下であること
```

---

## 障害の優先度評価

### リスクマトリクス

| 障害ID | 障害名 | 影響度 | 発生確率 | リスク値 | 優先度 |
|-------|-------|-------|---------|---------|-------|
| O1-1 | 衛星データ取得失敗 | 高 (5) | 中 (3) | 15 | 🔴 P1 |
| O2-1 | セキュリティテスト未実施 | 高 (5) | 中 (3) | 15 | 🔴 P1 |
| O2-2 | SQLインジェクション成功 | 高 (5) | 低 (1) | 5 | 🟡 P2 |
| O2-3 | XSS攻撃成功 | 中 (3) | 低 (1) | 3 | 🟢 P3 |
| O1-2 | 座標ズレ | 中 (3) | 低 (1) | 3 | 🟢 P3 |
| O3-1 | 不正な入力挿入 | 中 (3) | 中 (3) | 9 | 🟡 P2 |
| O3-2 | パフォーマンス低下 | 中 (3) | 中 (3) | 9 | 🟡 P2 |

### 優先度定義

- **P1（最優先）**: リスク値 ≥ 15 → 即座に対応必須
- **P2（高優先）**: リスク値 5～14 → 次期リリースで対応
- **P3（中優先）**: リスク値 < 5 → 継続的改善で対応

---

## 回避策の実装状況

### 実装済み（✅）

| 回避策ID | 内容 | 実装箇所 | 検証方法 |
|---------|------|---------|---------|
| R1-1-2 | フォールバック表示 | frontend/js/app.js:184 | 目視確認 |
| R1-1-4 | エラーログ記録 | backend/api.php:writeLog | backend/logs/ |
| R1-2-1 | リアルタイムバリデーション | frontend/js/app.js:76-118 | test_security.sh:Test 9,10 |
| R1-2-2 | Haversine精度向上 | backend/api.php:746-780 | 単体テスト（誤差<1km） |
| R1-2-4 | 座標系統一（WGS84） | データベース設計 | スキーマ定義 |
| R2-1-1 | セキュリティテスト自動化 | backend/test_security.sh | 12/12 PASSED |
| R2-1-3 | デプロイチェックリスト | DEPLOYMENT.md | 文書確認 |
| R2-2-1 | プリペアドステートメント | backend/api.php全体 | test_security.sh:Test 1,2 |
| R2-2-2 | 入力型チェック | backend/api.php:445-471 | test_security.sh:Test 1,2 |
| R2-2-3 | SQLiテスト | test_security.sh:Test 1,2 | 自動テスト |
| R2-3-1 | HTMLタグ除去 | backend/api.php:446,477-480 | test_security.sh:Test 3 |
| R2-3-2 | JSONレスポンス設定 | backend/api.php:ヘッダー | curl確認 |
| R2-3-3 | XSSテスト | test_security.sh:Test 3 | 自動テスト |
| R3-1-1 | フロントエンド検証 | frontend/js/app.js:76-118 | 目視確認 |
| R3-1-2 | バックエンド二重検証 | backend/api.php:445-471 | test_security.sh:Test 9,10 |
| R3-2-1 | DBインデックス最適化 | backend/db_setup.sql | EXPLAIN ANALYZE |

### 未実装（🔶）- 今後の課題

| 回避策ID | 内容 | 優先度 | 予定リリース |
|---------|------|-------|-------------|
| R1-1-1 | キャッシュ機構 | P1 | v1.1 |
| R1-1-3 | リトライ機構 | P1 | v1.1 |
| R1-2-3 | 座標ズレ検出機構 | P3 | v1.2 |
| R2-1-2 | CI/CDパイプライン | P1 | v1.1 |
| R2-1-4 | 継続的セキュリティスキャン | P2 | v1.2 |
| R2-2-4 | コードレビューガイドライン | P2 | v1.1 |
| R2-3-4 | Content Security Policy | P2 | v1.2 |
| R3-1-3 | データベースCHECK制約 | P2 | v1.1 |
| R3-1-4 | APIレート制限 | P2 | v1.2 |
| R3-2-2 | ページネーション | P2 | v1.2 |
| R3-2-3 | 遅延ロード | P2 | v1.2 |
| R3-2-4 | キャッシング機構 | P1 | v1.1 |
| R3-2-5 | Chart.js最適化 | P3 | v1.3 |

---

## まとめ

### 障害分析の成果

1. **7つの主要障害を特定**: O1-1～O3-2
2. **30以上の回避策を設計**: R1-1-1～R3-2-5
3. **16の回避策を実装済み**: セキュリティ・入力検証が中心
4. **13の未実装課題を明確化**: キャッシング・CI/CDがP1

### 次期リリース（v1.1）の重点課題

**P1（最優先）**:
- R1-1-1: キャッシュ機構 → データ取得失敗時の復旧力向上
- R1-1-3: リトライ機構 → JAXA API障害への耐性向上
- R2-1-2: CI/CDパイプライン → セキュリティテストの自動化
- R3-2-4: キャッシング → パフォーマンス向上

### Alloyモデルとの統合

本障害分析で特定した障害シナリオは、`satellite_viewer_enhanced.als` の障害述語として形式化済み:

```alloy
pred ObstacleNoSatelliteData[s: State, loc: Location] { ... }
pred ObstacleCoordinateMismatch[o: Observation, ws: WeatherStation] { ... }
pred ObstacleFilterResultsEmpty[s, s': State, f: Filter] { ... }
```

これにより、**設計レベルでの障害の検出**が可能になっています。

---

**文書バージョン**: 1.0
**最終更新**: 2026-01-25
**承認者**: Koga Hiroaki
**関連文書**: REQUIREMENTS_ENGINEERING.md, satellite_viewer_enhanced.als
